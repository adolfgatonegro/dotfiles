#!/bin/sh
#
# niri-display
# gatoneg.ro
# 
# A script for controlling on/off state for available displays in niri.
# Probes niri for Probes xrandr for connected displays and allows the user
# to select one to sue. Also provides access to the DMS Displays settings page.
#
# Currently, it supports using either a single display, or all connected
# displays. Might add other options later, but this works fine for my use cases.

# TODO: Screen mirroring
# Niri doesnâ€™t have built-in output mirroring yet, but `wl-mirror` can be used
# as a workaround.
# See: https://yalter.github.io/niri/Screencasting.html#screen-mirroring

displays=()
while IFS= read -r display; do
  displays+=("$display")
done < <(niri msg outputs | awk '/^Output / { gsub(/.*\(|\)/,""); print }')

count=${#displays[@]}

if (( count == 1 )); then
	notify-send "ðŸ’» niri-display" "Only one display detected (${displays[0]})."
	exit 0
fi


singlescreen(){
	for display in "${displays[@]}"; do
	  if [[ "$display" == "$selected" ]]; then
		niri msg output "$display" on
	  else
		niri msg output "$display" off
	  fi
	done
}

multiscreen(){
	for display in "${displays[@]}"; do
		niri msg output "$display" on
	done
}

selected=$(printf '%s\n' "${displays[@]}" "Multi-display" "Open display settings" | rofi -dmenu -p "Select display:")

[[ -z "$selected" ]] && exit 0

case "$selected" in
	"Open display settings") dms ipc call settings openWith displays ; exit ;;
	"Multi-display") multiscreen ;;
	*) singlescreen "$selected" ;;
esac
